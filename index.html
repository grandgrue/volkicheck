<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>volkicheck - Was ist dir wichtig f√ºr Volketswil?</title>
    <meta name="description" content="Finde heraus, welcher Volketswil-Typ du bist. 30 Fragen zu Themen, die unsere Gemeinde bewegen.">
    <meta property="og:title" content="volkicheck - Was ist dir wichtig?">
    <meta property="og:description" content="Finde heraus, welcher Volketswil-Typ du bist!">
    <meta property="og:url" content="https://volkicheck.grue.ch">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            overscroll-behavior: none;
            min-height: 100%;
            margin: 0;
        }
        body.no-scroll {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        #root {
            min-height: 100%;
        }
        
        /* Swipe Animationen */
        @keyframes swipeLeft {
            to { transform: translateX(-150%) rotate(-20deg); opacity: 0; }
        }
        @keyframes swipeRight {
            to { transform: translateX(150%) rotate(20deg); opacity: 0; }
        }
        @keyframes swipeUp {
            to { transform: translateY(-150%); opacity: 0; }
        }
        @keyframes swipeDown {
            to { transform: translateY(150%); opacity: 0; }
        }
        @keyframes cardEnter {
            from { transform: scale(0.95) translateY(20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .swipe-left { animation: swipeLeft 0.4s ease-out forwards; }
        .swipe-right { animation: swipeRight 0.4s ease-out forwards; }
        .swipe-up { animation: swipeUp 0.3s ease-out forwards; }
        .swipe-down { animation: swipeDown 0.3s ease-out forwards; }
        .card-enter { animation: cardEnter 0.3s ease-out; }
        .float-animation { animation: float 2s ease-in-out infinite; }
        .pulse-animation { animation: pulse 2s ease-in-out infinite; }
        
        /* Touch feedback */
        .touch-feedback:active { transform: scale(0.95); }
        
        /* Gradient Button */
        .btn-gradient {
            background: linear-gradient(135deg, #0D9488 0%, #0891B2 100%);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // =====================================================
        // KONFIGURATION
        // =====================================================
        
        const API_URL = 'api.php';

        // Volketswil Wappen als SVG-Komponente
        const VolketswilWappen = ({ size = 80, className = "" }) => (
            <svg width={size} height={size * 1.17} viewBox="0 0 241.08 282.39" className={className}>
                <path d="m1 1 4.3469 182.58c3.1049 130.41 227.28 130.41 230.39 0l4.3469-182.58z" fill="#feeb00" stroke="#000" strokeWidth="2"/>
                <path d="m120.54 269.54-13.357-41.726-42.814 9.2951 29.457-32.43-29.457-32.43 42.814 9.2951 13.357-41.726 13.357 41.726 42.814-9.2951-29.457 32.43 29.457 32.43-42.814-9.2951z" fill="#d64229" stroke="#000" strokeWidth="1"/>
                <path d="m4.0299 128.26 233.02-1e-5 3.0299-127.26h-239.08z" fill="#fff" stroke="#000" strokeWidth="2"/>
                <path d="m1.0044 1.0014 1.5 63.438h57.469v-63.438zm58.969 63.438v63.812h60.625v-63.812zm60.625 0h60.625v-63.438h-60.625zm60.625 0v63.812h55.812l1.5312-63.812z"/>
            </svg>
        );
        
        const DIMENSIONS = {
            klima: { name: 'Klima & Natur', color: '#16A34A', emoji: 'üå±' },
            quartier: { name: 'Quartier & Wohnen', color: '#0891B2', emoji: 'üèòÔ∏è' },
            familie: { name: 'Familie & Soziales', color: '#DB2777', emoji: 'üë®‚Äçüë©‚Äçüëß' },
            mobilitaet: { name: 'Mobilit√§t', color: '#EA580C', emoji: 'üö¥' },
            demokratie: { name: 'Demokratie & Finanzen', color: '#7C3AED', emoji: 'ü§ù' }
        };

        const PERSONALITY_TYPES = {
            klima: {
                emoji: 'üå±',
                name: { m: 'Klima-Champion', f: 'Klima-Champion', d: 'Klima-Champion' },
                description: 'Du setzt dich f√ºr Klimaschutz, Biodiversit√§t und nachhaltige Landwirtschaft ein. Gr√ºnr√§ume, B√§ume und regionale Produkte liegen dir am Herzen.',
                color: '#16A34A', bgColor: '#F0FDF4'
            },
            quartier: {
                emoji: 'üèòÔ∏è',
                name: { m: 'Quartier-Gestalter', f: 'Quartier-Gestalterin', d: 'Quartier-Gestalter*in' },
                description: 'Dir liegt die Entwicklung lebenswerter Quartiere am Herzen. Bezahlbarer Wohnraum, sch√∂ne Pl√§tze und ein lebendiges Zentrum sind deine Themen.',
                color: '#0891B2', bgColor: '#ECFEFF'
            },
            familie: {
                emoji: 'üë®‚Äçüë©‚Äçüëß',
                name: { m: 'Familien-Anwalt', f: 'Familien-Anw√§ltin', d: 'Familien-Anw√§lt*in' },
                description: 'Kinder, Familien und √§ltere Menschen stehen bei dir im Mittelpunkt. Sichere Schulwege, Krippenpl√§tze und gute Altersversorgung sind dir wichtig.',
                color: '#DB2777', bgColor: '#FDF2F8'
            },
            mobilitaet: {
                emoji: 'üö¥',
                name: { m: 'Mobilit√§ts-Wender', f: 'Mobilit√§ts-Wenderin', d: 'Mobilit√§ts-Wender*in' },
                description: 'Du willst Volketswil sicherer und nachhaltiger mobil machen. Velowege, besserer √ñV und Tempo-30-Zonen sind deine Priorit√§ten.',
                color: '#EA580C', bgColor: '#FFF7ED'
            },
            demokratie: {
                emoji: 'ü§ù',
                name: { m: 'Demokratie-St√§rker', f: 'Demokratie-St√§rkerin', d: 'Demokratie-St√§rker*in' },
                description: 'Transparenz, Mitbestimmung und faire Finanzen sind dir wichtig. Du willst, dass alle mitreden k√∂nnen und Ressourcen gerecht verteilt werden.',
                color: '#7C3AED', bgColor: '#FAF5FF'
            },
            balanced: {
                emoji: '‚öñÔ∏è',
                name: { m: 'Ausgewogener Denker', f: 'Ausgewogene Denkerin', d: 'Ausgewogene*r Denker*in' },
                description: 'Du w√§gst alle Themen sorgf√§ltig ab und suchst ausgewogene L√∂sungen. Kein einzelnes Thema dominiert ‚Äì du siehst das grosse Ganze.',
                color: '#64748B', bgColor: '#F8FAFC'
            }
        };

        const RESPONSES = [
            { value: 'sehr_wichtig', label: 'Sehr wichtig', emoji: 'üíö', color: '#16A34A' },
            { value: 'wichtig', label: 'Wichtig', emoji: 'üëç', color: '#0891B2' },
            { value: 'egal', label: 'Egal', emoji: 'üòê', color: '#9CA3AF' },
            { value: 'unwichtig', label: 'Unwichtig', emoji: 'üëé', color: '#EF4444' }
        ];

        // =====================================================
        // INTRO SCREEN - mit Wohnort-Frage
        // =====================================================
        
        function IntroScreen({ onStart }) {
            const [showLocationQuestion, setShowLocationQuestion] = useState(false);
            
            if (showLocationQuestion) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-teal-50 via-white to-cyan-50 flex flex-col items-center justify-center p-6">
                        <div className="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full text-center">
                            <div className="text-5xl mb-4">üìç</div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">Wohnst du in Volketswil?</h2>
                            <p className="text-gray-600 mb-6">
                                Die Fragen beziehen sich auf unsere Gemeinde.
                            </p>
                            
                            <div className="space-y-3">
                                <button
                                    onClick={() => onStart(true)}
                                    className="w-full py-4 px-6 rounded-2xl border-2 border-teal-400 bg-teal-50 hover:bg-teal-100 transition text-lg font-medium text-teal-700 touch-feedback"
                                >
                                    Ja, ich wohne in Volketswil
                                </button>
                                <button
                                    onClick={() => onStart(false)}
                                    className="w-full py-4 px-6 rounded-2xl border-2 border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition text-lg font-medium text-gray-600 touch-feedback"
                                >
                                    Nein, aber ich mache trotzdem mit
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="min-h-screen bg-gradient-to-br from-teal-50 via-white to-cyan-50 flex flex-col items-center justify-center p-6">
                    <div className="text-center max-w-md">
                        <div className="mb-4 float-animation flex justify-center">
                            <VolketswilWappen size={80} />
                        </div>
                        <h1 className="text-3xl font-bold text-teal-700 mb-2">volkicheck</h1>
                        <p className="text-gray-600 mb-8">
                            Was ist dir wichtig f√ºr Volketswil?<br/>
                            <span className="text-sm text-gray-500">30 Fragen ¬∑ ca. 3 Minuten</span>
                        </p>
                        
                        <button
                            onClick={() => setShowLocationQuestion(true)}
                            className="btn-gradient text-white px-8 py-4 rounded-full font-semibold text-lg shadow-lg hover:shadow-xl transition-all touch-feedback"
                        >
                            Los geht's! üöÄ
                        </button>
                        
                        <p className="mt-8 text-xs text-gray-400">
                            Ein Projekt von Michael Gr√ºebler<br/>
                            Kandidat Gemeinderat Volketswil
                        </p>
                    </div>
                </div>
            );
        }

        // =====================================================
        // SWIPE CARD
        // =====================================================
        
        function SwipeCard({ question, onResponse, isAnimating, animationClass }) {
            const cardRef = useRef(null);
            const [dragStart, setDragStart] = useState(null);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            const [showHint, setShowHint] = useState(null);

            const handleDragStart = (e) => {
                if (isAnimating) return;
                const point = e.touches ? e.touches[0] : e;
                setDragStart({ x: point.clientX, y: point.clientY });
            };

            const handleDragMove = (e) => {
                if (!dragStart || isAnimating) return;
                const point = e.touches ? e.touches[0] : e;
                const dx = point.clientX - dragStart.x;
                const dy = point.clientY - dragStart.y;
                setDragOffset({ x: dx, y: dy });
                
                // Hint anzeigen basierend auf Richtung
                const threshold = 50;
                if (dx > threshold) setShowHint('wichtig');
                else if (dx < -threshold) setShowHint('unwichtig');
                else if (dy < -threshold) setShowHint('sehr_wichtig');
                else if (dy > threshold) setShowHint('egal');
                else setShowHint(null);
            };

            const handleDragEnd = () => {
                if (!dragStart || isAnimating) return;
                
                const threshold = 80;
                if (dragOffset.x > threshold) onResponse('wichtig');
                else if (dragOffset.x < -threshold) onResponse('unwichtig');
                else if (dragOffset.y < -threshold) onResponse('sehr_wichtig');
                else if (dragOffset.y > threshold) onResponse('egal');
                
                setDragStart(null);
                setDragOffset({ x: 0, y: 0 });
                setShowHint(null);
            };

            const rotation = dragOffset.x * 0.1;
            const opacity = Math.max(0.5, 1 - Math.abs(dragOffset.x) / 300);

            return (
                <div
                    ref={cardRef}
                    className={`absolute inset-4 bg-white rounded-3xl shadow-2xl p-6 flex flex-col cursor-grab active:cursor-grabbing ${animationClass}`}
                    style={{
                        transform: `translate(${dragOffset.x}px, ${dragOffset.y}px) rotate(${rotation}deg)`,
                        opacity: isAnimating ? 1 : opacity
                    }}
                    onMouseDown={handleDragStart}
                    onMouseMove={handleDragMove}
                    onMouseUp={handleDragEnd}
                    onMouseLeave={handleDragEnd}
                    onTouchStart={handleDragStart}
                    onTouchMove={handleDragMove}
                    onTouchEnd={handleDragEnd}
                >
                    {/* Kategorie */}
                    <div className="flex items-center gap-2 mb-4">
                        <span className="text-xl">{DIMENSIONS[question.dimension]?.emoji}</span>
                        <span className="text-sm text-gray-500">{question.category}</span>
                    </div>
                    
                    {/* Frage */}
                    <div className="flex-1 flex items-center justify-center">
                        <p className="text-xl text-center text-gray-800 leading-relaxed">
                            {question.question_text}
                        </p>
                    </div>
                    
                    {/* Swipe Hints */}
                    {showHint && (
                        <div className={`absolute inset-0 rounded-3xl flex items-center justify-center pointer-events-none
                            ${showHint === 'sehr_wichtig' ? 'bg-green-500/20' : ''}
                            ${showHint === 'wichtig' ? 'bg-cyan-500/20' : ''}
                            ${showHint === 'egal' ? 'bg-gray-500/20' : ''}
                            ${showHint === 'unwichtig' ? 'bg-red-500/20' : ''}
                        `}>
                            <span className="text-4xl">
                                {RESPONSES.find(r => r.value === showHint)?.emoji}
                            </span>
                        </div>
                    )}
                    
                    {/* Swipe Anleitung */}
                    <div className="mt-4 grid grid-cols-3 gap-2 text-center text-xs text-gray-400">
                        <div>üëà Unwichtig</div>
                        <div>üëÜ Sehr wichtig<br/>üëá Egal</div>
                        <div>Wichtig üëâ</div>
                    </div>
                </div>
            );
        }

        // =====================================================
        // BUTTON RESPONSES
        // =====================================================
        
        function ResponseButtons({ onResponse, disabled }) {
            return (
                <div className="grid grid-cols-4 gap-2 p-4">
                    {RESPONSES.map((r) => (
                        <button
                            key={r.value}
                            onClick={() => onResponse(r.value)}
                            disabled={disabled}
                            className="flex flex-col items-center gap-1 py-3 px-2 rounded-xl transition-all touch-feedback disabled:opacity-50"
                            style={{ backgroundColor: r.color + '20' }}
                        >
                            <span className="text-2xl">{r.emoji}</span>
                            <span className="text-xs font-medium" style={{ color: r.color }}>{r.label}</span>
                        </button>
                    ))}
                </div>
            );
        }

        // =====================================================
        // PROGRESS BAR
        // =====================================================
        
        function ProgressBar({ current, total }) {
            const percent = (current / total) * 100;
            const milestones = [
                { at: 10, text: 'üéØ Guter Start!' },
                { at: 15, text: '‚ö° Halbzeit!' },
                { at: 25, text: 'üî• Fast geschafft!' }
            ];
            
            const currentMilestone = milestones.find(m => m.at === current);
            
            return (
                <div className="px-4 py-2">
                    <div className="flex justify-between items-center mb-1">
                        <span className="text-sm text-gray-500">{current} / {total}</span>
                        {currentMilestone && (
                            <span className="text-sm font-medium text-teal-600 animate-pulse">
                                {currentMilestone.text}
                            </span>
                        )}
                    </div>
                    <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div 
                            className="h-full bg-gradient-to-r from-teal-400 to-cyan-500 rounded-full transition-all duration-300"
                            style={{ width: `${percent}%` }}
                        />
                    </div>
                </div>
            );
        }

        // =====================================================
        // QUESTION SCREEN
        // =====================================================
        
        function QuestionScreen({ questions, sessionId, onComplete }) {
            const [shuffledQuestions, setShuffledQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isAnimating, setIsAnimating] = useState(false);
            const [animationClass, setAnimationClass] = useState('card-enter');
            const [responses, setResponses] = useState({});

            // Fragen beim ersten Render zuf√§llig mischen
            React.useEffect(() => {
                const shuffled = [...questions].sort(() => Math.random() - 0.5);
                setShuffledQuestions(shuffled);
            }, [questions]);

            const currentQuestion = shuffledQuestions[currentIndex];
            const isLastQuestion = currentIndex === shuffledQuestions.length - 1;

            // Warten bis Fragen gemischt sind
            if (shuffledQuestions.length === 0) {
                return <LoadingScreen message="Fragen werden vorbereitet..." />;
            }

            const handleResponse = async (response) => {
                if (isAnimating) return;
                
                // Animation starten
                setIsAnimating(true);
                const animMap = {
                    'sehr_wichtig': 'swipe-up',
                    'wichtig': 'swipe-right',
                    'egal': 'swipe-down',
                    'unwichtig': 'swipe-left'
                };
                setAnimationClass(animMap[response]);
                
                // Antwort speichern
                setResponses(prev => ({ ...prev, [currentQuestion.id]: response }));
                
                // API Call
                try {
                    await fetch(API_URL + '?action=respond', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: sessionId,
                            question_id: currentQuestion.id,
                            response: response
                        })
                    });
                } catch (e) {
                    console.error('Failed to save response', e);
                }
                
                // N√§chste Frage oder Ende
                setTimeout(() => {
                    if (isLastQuestion) {
                        onComplete(responses);
                    } else {
                        setCurrentIndex(prev => prev + 1);
                        setAnimationClass('card-enter');
                        setIsAnimating(false);
                    }
                }, 350);
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-teal-50 via-white to-cyan-50 flex flex-col">
                    {/* Header */}
                    <div className="p-4 text-center">
                        <h1 className="text-xl font-bold text-teal-700">volkicheck</h1>
                    </div>
                    
                    {/* Progress */}
                    <ProgressBar current={currentIndex + 1} total={shuffledQuestions.length} />
                    
                    {/* Card Container */}
                    <div className="flex-1 relative min-h-[300px]">
                        {currentQuestion && (
                            <SwipeCard
                                key={currentQuestion.id}
                                question={currentQuestion}
                                onResponse={handleResponse}
                                isAnimating={isAnimating}
                                animationClass={animationClass}
                            />
                        )}
                    </div>
                    
                    {/* Response Buttons */}
                    <ResponseButtons onResponse={handleResponse} disabled={isAnimating} />
                </div>
            );
        }

        // =====================================================
        // GENDER SELECTION
        // =====================================================
        
        function GenderScreen({ onSelect }) {
            return (
                <div className="min-h-screen bg-gradient-to-br from-teal-50 via-white to-cyan-50 flex items-center justify-center p-6">
                    <div className="bg-white rounded-3xl shadow-xl p-8 max-w-md w-full text-center">
                        <div className="text-5xl mb-4">üëã</div>
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">Fast geschafft!</h2>
                        <p className="text-gray-600 mb-6">
                            Damit wir dich richtig ansprechen k√∂nnen:
                        </p>
                        
                        <div className="space-y-3">
                            <button
                                onClick={() => onSelect('f')}
                                className="w-full py-4 px-6 rounded-2xl border-2 border-teal-200 hover:border-teal-400 hover:bg-teal-50 transition text-lg font-medium text-gray-700 touch-feedback"
                            >
                                Weiblich
                            </button>
                            
                            <button
                                onClick={() => onSelect('m')}
                                className="w-full py-4 px-6 rounded-2xl border-2 border-teal-200 hover:border-teal-400 hover:bg-teal-50 transition text-lg font-medium text-gray-700 touch-feedback"
                            >
                                M√§nnlich
                            </button>
                            
                            <button
                                onClick={() => onSelect('d')}
                                className="w-full py-4 px-6 rounded-2xl border-2 border-teal-200 hover:border-teal-400 hover:bg-teal-50 transition text-lg font-medium text-gray-700 touch-feedback"
                            >
                                Divers / Keine Angabe
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // =====================================================
        // LOADING SCREEN
        // =====================================================
        
        function LoadingScreen({ message }) {
            return (
                <div className="min-h-screen bg-gradient-to-br from-teal-50 via-white to-cyan-50 flex items-center justify-center">
                    <div className="text-center">
                        <div className="text-5xl mb-4 pulse-animation">üîÆ</div>
                        <p className="text-gray-600">{message || 'Wird geladen...'}</p>
                    </div>
                </div>
            );
        }

        // =====================================================
        // RADAR CHART
        // =====================================================
        
        function RadarChart({ scores, size = 240 }) {
            const center = size / 2;
            const radius = size * 0.36;
            const dims = Object.keys(DIMENSIONS);
            const angleStep = (2 * Math.PI) / dims.length;
            
            const points = dims.map((dim, i) => {
                const angle = i * angleStep - Math.PI / 2;
                const value = (scores[dim] || 0) / 3;
                const x = center + radius * value * Math.cos(angle);
                const y = center + radius * value * Math.sin(angle);
                return { x, y, dim };
            });
            
            const pathD = points.map((p, i) => 
                `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`
            ).join(' ') + ' Z';
            
            return (
                <svg width={size} height={size} className="mx-auto">
                    {[0.33, 0.66, 1].map((level, li) => (
                        <polygon
                            key={li}
                            points={dims.map((_, i) => {
                                const angle = i * angleStep - Math.PI / 2;
                                return `${center + radius * level * Math.cos(angle)},${center + radius * level * Math.sin(angle)}`;
                            }).join(' ')}
                            fill="none" stroke="#E5E7EB" strokeWidth="1"
                        />
                    ))}
                    
                    {dims.map((dim, i) => {
                        const angle = i * angleStep - Math.PI / 2;
                        return (
                            <line key={dim}
                                x1={center} y1={center}
                                x2={center + radius * Math.cos(angle)}
                                y2={center + radius * Math.sin(angle)}
                                stroke="#E5E7EB" strokeWidth="1"
                            />
                        );
                    })}
                    
                    <path d={pathD} fill="rgba(13, 148, 136, 0.3)" stroke="#0D9488" strokeWidth="2" />
                    
                    {points.map((p, i) => (
                        <circle key={i} cx={p.x} cy={p.y} r="5"
                            fill={DIMENSIONS[p.dim].color} stroke="white" strokeWidth="2" />
                    ))}
                    
                    {dims.map((dim, i) => {
                        const angle = i * angleStep - Math.PI / 2;
                        const x = center + (radius + 24) * Math.cos(angle);
                        const y = center + (radius + 24) * Math.sin(angle);
                        return (
                            <text key={dim} x={x} y={y} textAnchor="middle" dominantBaseline="middle" fontSize="16">
                                {DIMENSIONS[dim].emoji}
                            </text>
                        );
                    })}
                </svg>
            );
        }

        // =====================================================
        // SHARE IMAGE GENERATOR
        // =====================================================
        
        function ShareImageGenerator({ personality, typeName, scores, comparePercent }) {
            const canvasRef = useRef(null);
            const [imageUrl, setImageUrl] = useState(null);

            useEffect(() => {
                generateImage();
            }, [personality, typeName, scores, comparePercent]);

            const generateImage = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const size = 1080;
                canvas.width = size;
                canvas.height = size;

                // Hintergrund
                const gradient = ctx.createLinearGradient(0, 0, size, size);
                gradient.addColorStop(0, '#F0FDFA');
                gradient.addColorStop(0.5, '#FFFFFF');
                gradient.addColorStop(1, '#ECFEFF');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, size, size);

                // Dekorative Kreise
                ctx.fillStyle = personality.color + '15';
                ctx.beginPath();
                ctx.arc(size * 0.85, size * 0.15, 150, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(size * 0.1, size * 0.9, 100, 0, Math.PI * 2);
                ctx.fill();

                // Header
                ctx.fillStyle = '#0D9488';
                ctx.font = 'bold 36px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('volkicheck', size / 2, 60);
                ctx.fillStyle = '#6B7280';
                ctx.font = '24px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText('Mein Ergebnis', size / 2, 95);

                // Karte
                const cardX = 80, cardY = 130, cardW = size - 160, cardH = 750;
                ctx.shadowColor = 'rgba(0,0,0,0.1)';
                ctx.shadowBlur = 30;
                ctx.shadowOffsetY = 10;
                ctx.fillStyle = personality.bgColor;
                ctx.beginPath();
                ctx.roundRect(cardX, cardY, cardW, cardH, 32);
                ctx.fill();
                ctx.shadowColor = 'transparent';

                // Emoji & Name
                ctx.font = '80px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(personality.emoji, size / 2, cardY + 100);
                ctx.fillStyle = personality.color;
                ctx.font = 'bold 48px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText(typeName, size / 2, cardY + 165);

                // Prozent Badge
                const percentText = `${comparePercent}% sehen das √§hnlich`;
                ctx.font = 'bold 24px -apple-system, BlinkMacSystemFont, sans-serif';
                const percentWidth = ctx.measureText(percentText).width + 40;
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.roundRect(size / 2 - percentWidth / 2, cardY + 185, percentWidth, 50, 25);
                ctx.fill();
                ctx.fillStyle = '#0D9488';
                ctx.fillText(percentText, size / 2, cardY + 218);

                // Beschreibung
                ctx.fillStyle = '#4B5563';
                ctx.font = '24px -apple-system, BlinkMacSystemFont, sans-serif';
                const words = personality.description.split(' ');
                let line = '', y = cardY + 275;
                for (const word of words) {
                    const testLine = line + word + ' ';
                    if (ctx.measureText(testLine).width > cardW - 80 && line) {
                        ctx.fillText(line.trim(), size / 2, y);
                        line = word + ' ';
                        y += 32;
                    } else {
                        line = testLine;
                    }
                }
                ctx.fillText(line.trim(), size / 2, y);

                // Radar Chart
                const radarCenterX = size / 2, radarCenterY = cardY + 580, radarRadius = 105;
                const dims = Object.keys(DIMENSIONS);
                const angleStep = (2 * Math.PI) / dims.length;

                ctx.strokeStyle = '#E5E7EB';
                ctx.lineWidth = 1;
                for (const level of [0.33, 0.66, 1]) {
                    ctx.beginPath();
                    dims.forEach((_, i) => {
                        const angle = i * angleStep - Math.PI / 2;
                        const x = radarCenterX + radarRadius * level * Math.cos(angle);
                        const y = radarCenterY + radarRadius * level * Math.sin(angle);
                        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                    });
                    ctx.closePath();
                    ctx.stroke();
                }

                ctx.fillStyle = personality.color + '40';
                ctx.strokeStyle = personality.color;
                ctx.lineWidth = 3;
                ctx.beginPath();
                dims.forEach((dim, i) => {
                    const angle = i * angleStep - Math.PI / 2;
                    const value = (scores[dim] || 0) / 3;
                    const x = radarCenterX + radarRadius * value * Math.cos(angle);
                    const y = radarCenterY + radarRadius * value * Math.sin(angle);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                });
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                // Labels
                const dimLabels = { klima: 'üå± Klima', quartier: 'üèòÔ∏è Quartier', familie: 'üë®‚Äçüë©‚Äçüëß Familie', mobilitaet: 'üö¥ Mobilit√§t', demokratie: 'ü§ù Demokratie' };
                ctx.font = '22px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillStyle = '#374151';
                dims.forEach((dim, i) => {
                    const angle = i * angleStep - Math.PI / 2;
                    let x = radarCenterX + (radarRadius + 45) * Math.cos(angle);
                    let y = radarCenterY + (radarRadius + 45) * Math.sin(angle);
                    ctx.textAlign = i === 0 ? 'center' : i < 3 ? 'left' : 'right';
                    if (i >= 3) x -= 10; else if (i > 0) x += 10;
                    ctx.fillText(dimLabels[dim], x, y + 7);
                });

                // Footer
                ctx.textAlign = 'center';
                ctx.fillStyle = '#0D9488';
                ctx.font = 'bold 28px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText('Welcher Typ bist du?', size / 2, size - 80);
                ctx.fillStyle = '#6B7280';
                ctx.font = '26px -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.fillText('volkicheck.grue.ch', size / 2, size - 45);

                setImageUrl(canvas.toDataURL('image/png'));
            };

            return (
                <div>
                    <canvas ref={canvasRef} style={{ display: 'none' }} />
                    {imageUrl && (
                        <div className="space-y-3">
                            <img src={imageUrl} alt="Ergebnis" className="w-full rounded-xl shadow-lg" />
                            <a href={imageUrl} download="mein-volkicheck-ergebnis.png"
                                className="block w-full bg-gradient-to-r from-violet-500 to-purple-600 text-white py-3 rounded-full font-semibold text-center">
                                üì• Bild speichern
                            </a>
                        </div>
                    )}
                </div>
            );
        }

        // =====================================================
        // SHARE MODAL
        // =====================================================
        
        function ShareModal({ isOpen, onClose, personality, typeName, scores, comparePercent }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" onClick={onClose}>
                    <div className="bg-white rounded-3xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-gray-800">Ergebnis teilen</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
                        </div>
                        <p className="text-sm text-gray-600 mb-4">
                            Speichere das Bild und teile es auf Instagram, WhatsApp, oder wo du m√∂chtest!
                        </p>
                        <ShareImageGenerator personality={personality} typeName={typeName} scores={scores} comparePercent={comparePercent} />
                    </div>
                </div>
            );
        }

        // =====================================================
        // CALL TO ACTION COMPONENT
        // =====================================================
        
        function CallToAction({ result }) {
            const isLowScore = result.is_low_score;
            const livesInVolketswil = result.lives_in_volketswil;
            const topStatements = result.top_statements || [];
            
            // Variante A: Volketswiler mit hohem Score
            if (livesInVolketswil && !isLowScore) {
                return (
                    <div className="px-4 pb-6">
                        <div className="bg-gradient-to-br from-teal-600 to-cyan-600 rounded-3xl shadow-xl p-6 max-w-md mx-auto text-white">
                            <h3 className="text-xl font-bold mb-4 text-center">üó≥Ô∏è Deine Stimme z√§hlt!</h3>
                            
                            <p className="text-teal-100 mb-3 text-sm">Dir ist wichtig, dass...</p>
                            
                            <ul className="space-y-2 mb-5">
                                {topStatements.slice(0, 2).map((s, i) => (
                                    <li key={i} className="flex items-start gap-2 text-sm">
                                        <span className="text-teal-200 mt-0.5">‚úì</span>
                                        <span>{s.question_text}</span>
                                    </li>
                                ))}
                            </ul>
                            
                            <p className="text-sm text-teal-100 mb-5 leading-relaxed">
                                Diese Anliegen werden nur umgesetzt, wenn Menschen wie du sich engagieren.
                                <br/><br/>
                                Am <strong className="text-white">8. M√§rz 2025</strong> kannst du etwas bewirken: 
                                W√§hle Michael Gr√ºebler in den Gemeinderat ‚Äì f√ºr ein gr√ºneres, sozialeres Volketswil.
                            </p>
                            
                            <div className="space-y-3">
                                <a 
                                    href="https://www.grue.ch" 
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="block w-full bg-white text-teal-700 py-3 rounded-xl font-semibold text-center hover:bg-teal-50 transition"
                                >
                                    üå± Michael Gr√ºebler kennenlernen
                                </a>
                                <a 
                                    href="https://gruene-usterland.ch/kontakt-gruene-schwerzenbach-volketswil/" 
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="block w-full bg-teal-500/30 text-white py-3 rounded-xl font-semibold text-center hover:bg-teal-500/50 transition"
                                >
                                    üíö Newsletter / Mitglied werden
                                </a>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Variante B: Volketswiler mit tiefem Score
            if (livesInVolketswil && isLowScore) {
                return (
                    <div className="px-4 pb-6">
                        <div className="bg-gradient-to-br from-slate-600 to-gray-600 rounded-3xl shadow-xl p-6 max-w-md mx-auto text-white">
                            <h3 className="text-xl font-bold mb-4 text-center">üèõÔ∏è Demokratie lebt von Vielfalt</h3>
                            
                            <p className="text-sm text-gray-200 mb-5 leading-relaxed">
                                Du siehst einige Dinge anders ‚Äì das ist wichtig f√ºr eine lebendige Demokratie.
                                <br/><br/>
                                Falls dir ein Thema besonders am Herzen liegt, engagiere dich in deiner Gemeinde. 
                                Am <strong className="text-white">8. M√§rz 2025</strong> sind Wahlen ‚Äì jede Stimme z√§hlt!
                            </p>
                            
                            <div className="space-y-3">
                                <a 
                                    href="https://www.volketswil.ch" 
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="block w-full bg-white text-gray-700 py-3 rounded-xl font-semibold text-center hover:bg-gray-50 transition"
                                >
                                    üèòÔ∏è Gemeinde Volketswil
                                </a>
                                <a 
                                    href="https://www.grue.ch" 
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="block w-full bg-slate-500/30 text-white py-3 rounded-xl font-semibold text-center hover:bg-slate-500/50 transition"
                                >
                                    üìã Alle Kandidierenden ansehen
                                </a>
                            </div>
                        </div>
                    </div>
                );
            }
            
            // Variante C: Nicht-Volketswiler
            return (
                <div className="px-4 pb-6">
                    <div className="bg-gradient-to-br from-emerald-600 to-green-600 rounded-3xl shadow-xl p-6 max-w-md mx-auto text-white">
                        <h3 className="text-xl font-bold mb-4 text-center">üåç Danke f√ºrs Mitmachen!</h3>
                        
                        {topStatements.length > 0 && (
                            <>
                                <p className="text-sm text-emerald-100 mb-3">Dir ist wichtig, dass...</p>
                                <ul className="space-y-2 mb-5">
                                    {topStatements.slice(0, 2).map((s, i) => (
                                        <li key={i} className="flex items-start gap-2 text-sm">
                                            <span className="text-emerald-200 mt-0.5">‚úì</span>
                                            <span>{s.question_text}</span>
                                        </li>
                                    ))}
                                </ul>
                            </>
                        )}
                        
                        <p className="text-sm text-emerald-100 mb-5 leading-relaxed">
                            Auch in deiner Gemeinde gibt es bestimmt Menschen, die sich f√ºr √§hnliche Anliegen einsetzen. 
                            Engagiere dich lokal ‚Äì jede Stimme z√§hlt!
                        </p>
                        
                        <div className="space-y-3">
                            <a 
                                href="https://gruene.ch" 
                                target="_blank"
                                rel="noopener noreferrer"
                                className="block w-full bg-white text-emerald-700 py-3 rounded-xl font-semibold text-center hover:bg-emerald-50 transition"
                            >
                                üíö Gr√ºne Schweiz
                            </a>
                            <button 
                                onClick={() => {
                                    navigator.clipboard.writeText('Finde heraus, welcher Typ du bist: https://volkicheck.grue.ch');
                                    alert('Link kopiert! üìã');
                                }}
                                className="block w-full bg-emerald-500/30 text-white py-3 rounded-xl font-semibold text-center hover:bg-emerald-500/50 transition"
                            >
                                üîó volkicheck teilen
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // =====================================================
        // RESULT SCREEN
        // =====================================================
        
        function ResultScreen({ result }) {
            const [showShareModal, setShowShareModal] = useState(false);
            
            const personality = PERSONALITY_TYPES[result.personality_type] || PERSONALITY_TYPES.balanced;
            const typeName = personality.name[result.gender] || personality.name.d;
            
            const sortedDims = Object.entries(result.dimension_scores)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);

            const handleShare = (platform) => {
                const text = `Ich bin ${result.gender === 'f' ? 'eine' : result.gender === 'm' ? 'ein' : 'ein*e'} ${typeName}! üéØ Finde heraus, welcher Volketswil-Typ du bist:`;
                const url = 'https://volkicheck.grue.ch';
                
                if (platform === 'whatsapp') {
                    window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`, '_blank');
                } else if (platform === 'image') {
                    setShowShareModal(true);
                } else if (platform === 'copy') {
                    navigator.clipboard.writeText(text + ' ' + url);
                    alert('Link kopiert! üìã');
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-teal-50 via-white to-cyan-50" style={{ paddingBottom: '2rem' }}>
                    <div className="p-4 flex items-center justify-center gap-3">
                        <VolketswilWappen size={32} />
                        <div className="text-center">
                            <h1 className="text-xl font-bold text-teal-700">volkicheck</h1>
                            <p className="text-sm text-gray-500">Dein Ergebnis</p>
                        </div>
                    </div>
                    
                    <div className="px-4 pb-8">
                        <div className="rounded-3xl shadow-xl p-5 max-w-md mx-auto" style={{ backgroundColor: personality.bgColor }}>
                            
                            {result.is_low_score && (
                                <div className="mb-4 p-3 bg-white/70 rounded-xl text-sm text-gray-600 text-center">
                                    üí≠ Du siehst einige Dinge anders als die meisten Teilnehmenden. 
                                    Das ist wertvoll ‚Äì Vielfalt macht die Debatte reicher.
                                </div>
                            )}
                            
                            <div className="text-center mb-5">
                                <div className="text-6xl mb-2 float-animation">{personality.emoji}</div>
                                <h2 className="text-2xl font-bold mb-2" style={{ color: personality.color }}>{typeName}</h2>
                                <p className="text-gray-600 text-sm leading-relaxed px-2">{personality.description}</p>
                            </div>
                            
                            <div className="bg-white/70 rounded-2xl p-4 mb-5">
                                <div className="flex items-center justify-center gap-3">
                                    <div className="text-3xl font-bold text-teal-600">{result.compare_percent}%</div>
                                    <div className="text-sm text-gray-600 text-left">
                                        der Teilnehmenden<br/>sehen das √§hnlich wie du
                                    </div>
                                </div>
                            </div>
                            
                            <div className="bg-white/70 rounded-2xl p-4 mb-5">
                                <h3 className="text-center text-sm font-semibold text-gray-700 mb-1">Dein Profil</h3>
                                <RadarChart scores={result.dimension_scores} />
                                <div className="flex flex-wrap justify-center gap-x-3 gap-y-1 mt-2 text-xs text-gray-500">
                                    {Object.entries(DIMENSIONS).map(([key, dim]) => (
                                        <span key={key}>{dim.emoji} {dim.name}</span>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="bg-white/70 rounded-2xl p-4 mb-5">
                                <h3 className="text-sm font-semibold text-gray-700 mb-3">Deine Top-Themen</h3>
                                <div className="space-y-3">
                                    {sortedDims.map(([dimKey, score]) => {
                                        const dim = DIMENSIONS[dimKey];
                                        return (
                                            <div key={dimKey} className="flex items-center gap-3">
                                                <span className="text-xl w-8">{dim.emoji}</span>
                                                <div className="flex-1">
                                                    <div className="flex justify-between text-sm mb-1">
                                                        <span className="font-medium text-gray-700">{dim.name}</span>
                                                        <span className="text-gray-400">{score.toFixed(1)}/3</span>
                                                    </div>
                                                    <div className="h-2.5 bg-gray-200 rounded-full overflow-hidden">
                                                        <div className="h-full rounded-full" style={{ width: `${(score/3)*100}%`, backgroundColor: dim.color }} />
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            
                            <div className="text-center">
                                <p className="text-sm text-gray-600 mb-3">Teile dein Ergebnis:</p>
                                <div className="flex flex-wrap justify-center gap-2">
                                    <button onClick={() => handleShare('whatsapp')} className="flex items-center gap-2 px-4 py-2.5 rounded-full text-white font-medium text-sm bg-[#25D366]">
                                        üì± WhatsApp
                                    </button>
                                    <button onClick={() => handleShare('image')} className="flex items-center gap-2 px-4 py-2.5 rounded-full text-white font-medium text-sm bg-[#8B5CF6]">
                                        üñºÔ∏è Als Bild speichern
                                    </button>
                                    <button onClick={() => handleShare('copy')} className="flex items-center gap-2 px-4 py-2.5 rounded-full text-white font-medium text-sm bg-[#64748B]">
                                        üìã Kopieren
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Call to Action */}
                    <CallToAction result={result} />
                    
                    <div className="text-center pb-8 text-xs text-gray-400">
                        <p>volkicheck.grue.ch</p>
                    </div>

                    <ShareModal 
                        isOpen={showShareModal}
                        onClose={() => setShowShareModal(false)}
                        personality={personality}
                        typeName={typeName}
                        scores={result.dimension_scores}
                        comparePercent={result.compare_percent}
                    />
                </div>
            );
        }

        // =====================================================
        // MAIN APP
        // =====================================================
        
        function App() {
            const [screen, setScreen] = useState('intro'); // intro, questions, gender, loading, result
            const [questions, setQuestions] = useState([]);
            const [sessionId, setSessionId] = useState(null);
            const [result, setResult] = useState(null);

            const startQuiz = async (livesInVolketswil) => {
                setScreen('loading');
                
                try {
                    // Fragen laden
                    const qRes = await fetch(API_URL + '?action=questions');
                    const qData = await qRes.json();
                    setQuestions(qData.questions);
                    
                    // Session starten mit Wohnort-Info
                    const sRes = await fetch(API_URL + '?action=start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ lives_in_volketswil: livesInVolketswil })
                    });
                    const sData = await sRes.json();
                    setSessionId(sData.session_id);
                    
                    setScreen('questions');
                } catch (e) {
                    console.error('Failed to start', e);
                    alert('Fehler beim Laden. Bitte versuche es erneut.');
                    setScreen('intro');
                }
            };

            const handleQuestionsComplete = () => {
                setScreen('gender');
            };

            const handleGenderSelect = async (gender) => {
                setScreen('loading');
                
                try {
                    // Session abschliessen
                    await fetch(API_URL + '?action=complete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_id: sessionId, gender })
                    });
                    
                    // Ergebnis laden
                    const rRes = await fetch(API_URL + '?action=result&sid=' + sessionId);
                    const rData = await rRes.json();
                    setResult(rData);
                    
                    setScreen('result');
                } catch (e) {
                    console.error('Failed to complete', e);
                    alert('Fehler beim Berechnen. Bitte versuche es erneut.');
                }
            };

            // Scroll-Verhalten dynamisch steuern
            React.useEffect(() => {
                if (screen === 'result') {
                    document.body.classList.remove('no-scroll');
                    window.scrollTo(0, 0);
                } else {
                    document.body.classList.add('no-scroll');
                }
            }, [screen]);

            switch (screen) {
                case 'intro':
                    return <IntroScreen onStart={startQuiz} />;
                case 'loading':
                    return <LoadingScreen message="Dein Ergebnis wird berechnet..." />;
                case 'questions':
                    return <QuestionScreen questions={questions} sessionId={sessionId} onComplete={handleQuestionsComplete} />;
                case 'gender':
                    return <GenderScreen onSelect={handleGenderSelect} />;
                case 'result':
                    return <ResultScreen result={result} />;
                default:
                    return <IntroScreen onStart={startQuiz} />;
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
